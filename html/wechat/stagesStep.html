<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no" />
    <meta http-equiv="cache-control" content="no-cache">
    <title>我要分期</title>
    <link href="css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<section>
<div class="stSInfo">
    <img src="images/80_80.jpg" />
    <p></p>
    <div class="clear"></div>
</div>
</section>

<section>
<div class="stSmon">
    <div class="stSOpt">
        <span class="fl">商品金额</span>
        <input type="text" placeholder="含运费，介于1500 - 7500" id="money" />
    </div>
    <div class="stSOpt" id="payment">
        <span class="fl">首付比例</span>
        <img src="images/set_a.png" />
        <samp></samp>
    </div>
    <div class="stSOpt" id="nper">
        <span class="fl">分期数</span>
        <img src="images/set_a.png" />
        <samp></samp>
    </div>
    <div class="stSNote">
        <div class="stSFl">商品备注</div>
        <div class="stSFr"><textarea id="shopMark"></textarea></div>
        <div class="clear"></div>
    </div>
    
    <div class="stSum">
        <p>首　付：￥<span></span></p>
        <p>分期金额：￥<span></span></p>
        <p>分期数：<span></span></p>
        <p>每期还款：￥<span></span></p>
        <samp></samp>
    </div>
</div>
</section>

<section>
<div class="stUInfo" style="display:none;">
    <div class="stUTop">
        <p><span class="fr">商品总额：￥<samp class="stUsam1"></samp></span></p>
        <p><span class="fl">首　付：￥<samp class="stUsam2"></samp></span><span class="fr">分期金额：￥<samp class="stUsam3"></samp></span></p>
        <p><span class="fl">分期数：<samp class="stUsam4"></samp>期</span><span class="fr">每期还款：￥<samp class="stUsam5"></samp></span></p>
    </div>   
    <div class="stUBot">
        <div class="editFopt editFopt1">
            <samp>姓名</samp>
            <input type="text" placeholder="请输入姓名" id="name">
            <i class="iDele" onClick="iDele(this)"><img src="images/delete.png" /></i>
        </div>
        <div class="editFopt editFopt1">
            <samp>手机号</samp>
            <input type="text" placeholder="请输入手机号" id="tel">
            <i class="iDele" onClick="iDele(this)"><img src="images/delete.png" /></i>
        </div>
        <div class="editFopt editFopt1">
            <samp>短信验证码</samp>
            <input type="text" placeholder="请输入验证码" class="editFinp" id="smsCode">
            <a href="javascript:" onClick="iTime(this)">获取验证码</a>
            <span class="hidden"><samp>60</samp>秒后重发</span>
            <i class="iDele" onClick="iDele(this)">
            <img src="images/delete.png" /></i>
        </div>
        <div class="editFopt editFopt1">
            <samp>身份证号码</samp>
            <input type="text" placeholder="请输入身份证号码" id="card">
            <i class="iDele" onClick="iDele(this)"><img src="images/delete.png" /></i>
        </div>
    </div> 
</div>
</section>

<section>
<div class="stSign" style="display:none;">
    <div class="stSTop">
        <div class="stSOpt" onClick="addPop(this)" id="mqAdd">
            <span class="fl">面签地址</span>
            <img src="images/set_a.png" />
            <samp></samp>
        </div>
        <div class="stSNote">
            <div class="stSFl">街道门牌信息</div>
            <div class="stSFr"><textarea id="mqTextarea"></textarea></div>
            <div class="clear"></div>
        </div>
    </div>
    <a href="javascript:" onClick="checkAdd(this)"><img src="img/qas.png" />设面签地址为收货地址</a>
    <a href="javascript:" onClick="checkAdd(this)"><img src="img/vrwrtbth.png" />新增收货地址</a>
    <div class="stSTop stSTop1">
        <div class="stSOpt" onClick="addPop(this)" id="newAdd">
            <span class="fl">收货地址</span>
            <img src="images/set_a.png" />
            <samp>广东省深圳市</samp>
        </div>
        <div class="stSNote">
            <div class="stSFl">街道门牌信息</div>
            <div class="stSFr"><textarea id="newTextarea"></textarea></div>
            <div class="clear"></div>
        </div>
    </div>
</div>
</section>

<section>
<div class="stA"><a href="javascript:" onClick="prev()" id="prev">上一步</a><a href="javascript:" class="stAa2" onClick="next()" id="next">下一步</a></div>
</section>

<!--首付比例-->
<div class="pop" id="payPop">
    <div class="popBg"></div>
    <div class="popCon">
        <div class="popCTop">首付比例<a href="javascript:popClose()"><img src="images/st_close.png" /></a></div>
        <div class="popCCon" id="ratio_slt">
            <a href="javascript:" value="0.2" onClick="payA(this)">20%</a>
            <a href="javascript:" value="0.25" onClick="payA(this)">25%</a>
            <a href="javascript:" value="0.3" onClick="payA(this)">30%</a>
        </div>
    </div>
</div>

<!--分期数-->
<div class="pop" id="nperPop">
    <div class="popBg"></div>
    <div class="popCon">
        <div class="popCTop">分期数<a href="javascript:popClose()"><img src="images/st_close.png" /></a></div>
        <div class="popCCon" id="peroids_slt"></div>
    </div>
</div>

<!--地址-->
<div class="pop" id="addPop">
    <div class="popBg"></div>
    <div class="popCon">
        <div class="popCTop">选择地址<a href="javascript:popClose()"><img src="images/st_close.png" /></a></div>
        <div class="popCCon" id="province"></div>
        <div class="popCCon hidden" id="city"></div>
        <div class="popCCon hidden" id="area"></div>
    </div>
</div>

<script src="js/jquery-1.12.3.min.js"></script>
<script src="js/common.js"></script>
<script src="js/input.js"></script>
<script type="text/javascript">
var money;      //商品总额
var payment;    //首付
var nper;       //分期数
var amount;     //分期金额
var eachPayment //每期还款
var page = 1;
var addId;      //地址
var shopName;   //商品名称
var shopUrl;    //商品链接地址
var shopImgUrl; //商品图片链接地址
var shopMark;   //商品备注 
var channelId;  //渠道ID
var payId;      //首付比例id 
var productNo;  //分期编码
var userName;
var userTel;
var userCard;
var smsCode;
var mqProvince;
var mqCity;
var mqArea;
var mqAdd;
var newAdd;
var serverPayment;

$(function(){
	var Request = new Object();
	Request = GetRequest(); 
	shopUrl = Request["url"];
	
	$(".popBg").height($(window).height());
	$("#money").val("");
	
	$.get(basePath+"/crawler/item.do?url="+shopUrl,function(data){
		if(data.status == 0){
			shopName = data.data.desc;
			channelId = data.data.name;
			shopImgUrl = data.data.imgURL;
			if(shopImgUrl){
				$(".stSInfo").find("img").attr("src",shopImgUrl);
			}else{
				$(".stSInfo").find("img").attr("src","images/80_80.jpg");
			}
			$(".stSInfo").find("p").text(data.data.desc);
		}else{
			textLog(data.message);
		}
	});
	
	//获取省份
	$.get(basePath+"/GW/order/getProvince.do",function(data){
		$.each(data.data,function(i,item){
			var a = "<a href='javascript:' code="+item.code+" onclick=provA(this)>"+item.name+"</a>";
			$(a).appendTo("#province");
		});
	});
	
	$("#money").blur(function(){
		var reg = /^[1-9]\d{3}(\.\d{1,2})?$/;
		var val = $(this).val();
		money = $(this).val();
		if(val == ""){
		    textLog("商品金额不能为空");
			return;
		}else if(!reg.test(val) || 1500>val || val>7500){
		    textLog("请输入数字,商品金额介于1500-7500");
			return;
		}
	});
	
	//首付
	$("#payment").click(function(){
		if($("#money").val() == ""){
			textLog("请输入商品金额");
			return false;
		}
		$("#payPop").fadeIn();
	});
	
	//分期
	$("#nper").click(function(){
		if($("#money").val() == ""){
			textLog("请输入商品金额");
			return false;
		}
		$("#nperPop").fadeIn();
	});

});

//-==============================分期数据-=============

var payList = [] ; //
var typeList = [];
$.ajax({
	type: 'GET',
	url: basePath+"/data/audit/first_pay_account_data.do",
	dataType: 'json',
	success: function(data){
		if(data.status=='1'){
			textLog("数据请求失败！");
			return ;
		}
		payList = data.data;
		
	},error:function(err){
		textLog("请求错误！");
	}
});

$.ajax({
	type: 'GET',
	url: basePath+"/data/audit/business_type_data.do",
	dataType: 'json',
	success: function(data){
		if(data.status=='1'){
			textLog("数据请求失败！");
			return ;
		}
		typeList = data.data;
		
	},error:function(err){
		textLog("请求错误！");
	}
});

$("#money").change(function(){
	var price = parseFloat($(this).val());
	$("#ratio_slt a").remove();
	$("#peroids_slt a").remove();
	for(var i in payList){
		if(price>=payList[i].minAccount&&price<payList[i].maxAccount){
			//$("#ratio_slt").append('<option class="ratio"  payId="'+payList[i].id+'"  value="'+payList[i].firstRatio+'">'+payList[i].firstRatio+'%</option>');
			$("#ratio_slt").append('<a href="javascript:" payId="'+payList[i].id+'" onClick="payA(this)" value="'+payList[i].firstRatio+'">'+payList[i].firstRatio+'%</a>');
		}
		if(price==payList[i].maxAccount&&price==7500){
			$("#ratio_slt").append('<a href="javascript:" payId="'+payList[i].id+'" onClick="payA(this)" value="'+payList[i].firstRatio+'">'+payList[i].firstRatio+'%</a>');
			
		}
	}
	//清掉首付比例
	$("#payment").find("samp").text("");
	$("#nper").find("samp").text("");
	
});
//选择首付比例后
function ratioSelect(){
	$("#peroids_slt a").remove();
	for(var i in typeList){
		if(amount>=typeList[i].lowprincipal&&amount<=typeList[i].tallprincipal){
			//$("#peroids_slt").append('<option class="proids" typeno="'+typeList[i].typeno+'" rate = "'+typeList[i].customerservicerates+'%" value="'+typeList[i].term+'">'+typeList[i].term+'期</option>');
			$("#peroids_slt").append('<a href="javascript:" onClick="nperA(this)"  productNo="'+typeList[i].typeno+'" rate = "'+typeList[i].customerservicerates+'" value="'+typeList[i].term+'">'+typeList[i].term+'期</a>');
		}
	}
} 
 
 
//=============================分期数据end=========================
 

function payA(obj){
	popClose();
	money = $("#money").val();
	var scale = $(obj).attr("value");
	payment =  toDecimal(money*scale/100.00);
	amount = money - payment;
	payId = $(obj).attr("payId");//产品id
	ratioSelect();//更新期数
	$("#payment").find("samp").text(scale+"%");
	$(".stSum").css("visibility","inherit");
	$(".stSum").find("p").eq(0).show();
	$(".stSum").find("p").eq(0).find("span").text(payment);
	$(".stSum").find("p").eq(1).show();
	$(".stSum").find("p").eq(1).find("span").text(amount);
}

function nperA(obj){
	$("#nper").find("samp").text($(obj).text());
	nper = parseInt($(obj).text());
	var price = parseFloat(amount)/nper;
	var rate = $(obj).attr("rate");
	serverPayment = amount*rate/100.00;
	eachPayment = toDecimal(price+serverPayment);
	productNo = $(obj).attr("productNo");//
	popClose();
	$(".stSum").css("visibility","inherit");
	$(".stSum").find("p").eq(2).show();
	$(".stSum").find("p").eq(2).find("span").text($(obj).text());
	$(".stSum").find("p").eq(3).show();
	$(".stSum").find("p").eq(3).find("span").text(eachPayment);
	$(".stSum").find("samp").show();
	$(".stSum").find("samp").text("说　明：以上还款含每期分期服务费￥"+ toDecimal(serverPayment));
}

function popClose(){
	$(".pop").hide();
}

//地址
function addPop(obj){
	$("#addPop").fadeIn();
	$("#province").show();
	$("#city").hide();
	$("#area").hide();
	addId = $(obj).attr("id");
}

//选择省
function provA(obj){
	$(obj).addClass("addCa").siblings().removeClass("addCa");
	$("#province").hide();
	$("#city").show();
	var code = $(obj).attr("code");
	requestC(code);
}

//选择市
function cityA(obj){
	$(obj).addClass("addCa").siblings().removeClass("addCa");
	$("#city").hide();
	$("#area").show();
	$("#cityA").removeClass("addNTa");
	$("#areaA").addClass("addNTa");
	var code = $(obj).attr("code");
	requestA(code);
}

//选择区
function areaA(obj){
	$(obj).addClass("addCa").siblings().removeClass("addCa");
	var add = $("#province .addCa").text() + $("#city .addCa").text() + $("#area .addCa").text();
	$("#"+addId).find("samp").text(add);
	if(addId == "mqAdd"){
		mqProvince = $("#province .addCa").attr("code");
		mqCity = $("#city .addCa").attr("code");
		mqArea = $("#area .addCa").attr("code");
		mqAdd = add;
	}
	if(addId == "newAdd"){
		newAdd = add;
	}
	popClose();
}

//获取市
function requestC(code){
	$("#city").html("");
	$.get(basePath+"/GW/order/getAreas.do?parentId="+code,function(data){
		$.each(data.data,function(i,item){
			var a = "<a href='javascript:' code="+item.code+" onclick=cityA(this)>"+item.name+"</a>";
			$(a).appendTo("#city");
		});
	});
}

//获取区
function requestA(code){
	$.get(basePath+"/GW/order/getAreas.do?parentId="+code,function(data){
		$("#area").html("");
		$.each(data.data,function(i,item){
			var a = "<a href='javascript:' code="+item.code+" onclick=areaA(this)>"+item.name+"</a>";
			$(a).appendTo("#area");
		});
	});
}


//选择地址
function checkAdd(obj){ 
	var src = $(obj).children("img").attr("src");
	if(src == "img/vrwrtbth.png"){
		$(obj).children("img").attr("src","img/qas.png");
		$(obj).siblings("a").children("img").attr("src","img/vrwrtbth.png");
		if($(obj).text() == "新增收货地址"){
			$(".stSTop1").css("visibility","inherit");
		}else{
			$(".stSTop1").css("visibility","hidden");
		}
	}else{
		$(obj).children("img").attr("src","img/vrwrtbth.png");
		$(obj).siblings("a").children("img").attr("src","img/qas.png");
	}
}

//下一页
function next(){
	if(page == 1){
		shopMark = $("#shopMark").val();
		if($("#payment").find("samp").text()==""){
			textLog("首付比例不能为空");
			return;
		}
		if($("#nper").find("samp").text()==""){
			textLog("分期数不能为空");
			return;
		}
		if(shopMark==""){
			textLog("商品备注不能为空");
			return;
		}
		$(".stSmon").hide();
		$(".stUInfo").show();
		$(".stUsam1").text(money);
		$(".stUsam2").text(payment);
		$(".stUsam3").text(amount);
		$(".stUsam4").text(nper);
		$(".stUsam5").text(eachPayment);
		page++;
		return;
	}
	
	if(page == 2){
		$(".stAa2").text("提交");
		var nameReg = /[a-zA-Z]|[\u4E00-\u9FA5]{2,15}(?:·[\u4E00-\u9FA5]{2,15})*/;
		var telReg = /^(13[0-9]|14[0-9]|15[0-9]|18[0-9])\d{8}$/;
		var cardReg = /^(\d{6})(18|19|20)?(\d{2})(0[1-9]|1[0-2])(0[1-9]|[1-2][0-9]|3[0-1])(\d{3})(\d|X|x)?$/;
		userName = $("#name").val();
		userTel = $("#tel").val();
		userCard = $("#card").val();
		smsCode = $("#smsCode").val();
		
		if(userName == ""){
			textLog("请输入姓名");
			return;
		}else if(!nameReg.test(userName)){
			textLog("请输入正确姓名");
			return;
		}
		
		if(userTel == ""){
			textLog("请输入手机号码");
			return;
		}else if(!telReg.test(userTel)){
			textLog("请输入正确的手机号码");
			return;
		}
		
		if(smsCode == ""){
			textLog("请输入验证码");
			return;
		}
		
		if(userCard == ""){
			textLog("请输入身份证号码");
			return;
		}else if(!cardReg.test(userCard)){
			textLog("请输入正确的身份证号码");
			return;
		}else if(discriCard(userCard) < 18){
	 		textLog("小于18岁不允许分期！");
	 		return;
	 	}else if(discriCard(userCard) > 55){
	 		textLog("大于55岁不允许分期！");
	 		return;
	 	}
		
		$.get(basePath+"/data/purchase/checkCode?vcode="+smsCode+"&mobile="+userTel,function(data){
			if(data.status == 0){
				$(".stSInfo").hide();
				$(".stUInfo").hide();
				$(".stSign").show();
				page++;
				return;
			}else{
				textLog(data.message);
			}
		});
	}
	
	if(page == 3){
		if($("#mqAdd").find("samp").text() == ""){
			textLog("面签地址不能为空");
			return;
		}
		var mqText = $("#mqTextarea").val();
		if(mqText==""){
			textLog("街道门牌信息不能为空");
			return;
		}
		mqAdd += mqText;
        if($(".stSign a:last").find("img").attr("src") == "img/qas.png"){
			if($("#newAdd").find("samp").text() == ""){
				textLog("收货地址不能为空");
				return;
			}
			if($("#newTextarea").val() == ""){
				textLog("街道门牌信息不能为空");
				return;
			}
			newAdd += $("#newTextarea").val();
		}else{
			newAdd = mqAdd;
		}
		/* var parm = {"purchaseAmount":money,"purchaseLoadAmount":amount,
				"purchaseMonthAmount":eachPayment,"purchaseFistPay":payment,
				"purchasePeriods":nper,"purchaseGoodsName":shopName,
				"purchaseGoodsUrl":shopUrl,"purchaseGoodsImage":shopImgUrl,
				"purchaseGoodsRemark":shopMark,"purchaseContactName":userName,
				"purchaseContactMobile":userTel,"purchaseContactIdCart":userCard,
				"vcode":smsCode,"province":mqProvince,"city":mqCity,
				"district":mqArea,"address":mqStreet,"purchaseReceiverAddress":newAdd,
				"payId":payId,"productNo":productNo,"channelId":channelId} */
		var placeUrl = basePath+"/data/purchase/wechat/place_order.do?purchaseAmount="+money+"&purchaseLoadAmount="+amount
		+"&purchaseMonthAmount="+eachPayment+"&purchaseFistPay="+payment+"&purchasePeriods="
		+nper+"&purchaseGoodsName="+shopName+"&purchaseGoodsUrl="+shopUrl+"&purchaseGoodsImage="
		+shopImgUrl+"&purchaseGoodsRemark="+shopMark+"&purchaseContactName="
		+userName+"&purchaseContactMobile="+userTel+"&purchaseContactIdCart="
		+userCard+"&vcode="+smsCode+"&province="+mqProvince+"&city="
		+mqCity+"&district="+mqArea+"&address="+mqAdd+"&purchaseReceiverAddress="
		+newAdd+"&payId="+payId+"&productNo="+productNo+"&channelId="+channelId;
		
		$.ajax({
			url: placeUrl,
			type: 'post',
			dataType: 'json',
			success: function(data){
				if(data.status == "0"){
	 				var data = data.data;
					if(data != null){
						location.href = "stagesSuccess.html?pwd="+data;
					}else{
						location.href = "stagesSuccess.html";
					}
	 			}else{
	 				textLog(data.message);
	 			}
			}
		});
		/* $.post(basePath+"/data/purchase/wechat/place_order.do",parm,function(json){
	        alert("json:"+json);
			if(json.status == "0"){
 				var data = json.data;
				if(data != null){
					location.href = "stagesSuccess.html?pwd="+data;
				}else{
					location.href = "stagesSuccess.html";
				}
 			}else{
 				textLog(json.message);
 			}
		}); */
	}
}

//上一步
function prev(){
	if(page==3){
		$("#next").text("下一步");
        $(".stSInfo").show();
		$(".stUInfo").show();
		$(".stSign").hide();
		page--;
		return;
	}
	if(page == 2){
		$(".stSmon").show();
		$(".stUInfo").hide();
		page--;
		return;
	}
	if(page == 1){
		//location.href = "stages.html";
		history.back();
	}
}
 
//获取手机验证码
function iTime(obj){
	var reg = /^(17[0-9]|13[0-9]|14[0-9]|15[0-9]|18[0-9])\d{8}$/;
	var tel = $("#tel").val();
	if(tel == ""){
		textLog("请输入手机号");
		return;
	}else if(!reg.test(tel)){
		textLog("请输入正确的手机号");
		return;
	}
	$.get(basePath+"/data/user/"+$("#tel").val()+"?type=3",function(data){
		if(data.status == 0){
			$(obj).hide();
			$(obj).next().show();
			var n = $(obj).next().children("samp").text();
			var time;
			time = setInterval(function(){
				n--;
				$(obj).next().children("samp").text(n);
				if(n == 0){
					clearInterval(time);
					$(obj).next().children("samp").text(60);
					$(obj).show();
					$(obj).next().hide();
				}
			},1000);
		}else{
			textLog(data.message);
		}
	})
}    

//根据身份证号码获取年龄
function discriCard(UUserCard){
	 var myDate = new Date();
	 var month = myDate.getMonth() + 1;
	 var day = myDate.getDate();
	 var age = myDate.getFullYear() - UUserCard.substring(6, 10) - 1;
	 if (UUserCard.substring(10, 12) < month || UUserCard.substring(10, 12) == month && UUserCard.substring(12, 14) <= day) {
	 age++;
	 }
    return age;
}
</script>
</body>
</html>